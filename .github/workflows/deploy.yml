name: Deploy to Hostinger VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Docker image com retry nativo
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "üî® Tentativa $ATTEMPT de $MAX_ATTEMPTS..."
            
            if docker build \
              --build-arg NEXT_PUBLIC_API_URL=${{ secrets.NEXT_PUBLIC_API_URL }} \
              -t ${{ secrets.DOCKERHUB_USERNAME }}/miu-controle-frontend:latest \
              --progress=plain \
              --no-cache \
              .; then
              echo "‚úÖ Build conclu√≠do com sucesso!"
              break
            else
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "‚ùå Falhou ap√≥s $MAX_ATTEMPTS tentativas"
                exit 1
              fi
              echo "‚ö†Ô∏è  Falhou, aguardando 10s antes de retry..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
      
      - name: Login DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Push image
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/miu-controle-frontend:latest

  deploy:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /root/miu-controle
            docker compose pull frontend
            docker compose up -d frontend --force-recreate
            docker image prune -f
